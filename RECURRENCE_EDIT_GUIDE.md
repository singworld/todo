# 重复时间段单次调整功能说明

## 问题解决

**用户需求**: "重复的任务,我某一天需要调整,怎么处理"

**解决方案**: 编辑重复时间段时,提供两种模式选择:
- **仅编辑今天这一次** - 为当天创建独立副本,不影响其他日期
- **编辑所有重复** - 修改原始时间段,影响所有重复实例

---

## 使用流程

### 场景示例
你设置了**每天 10:00-12:00 学习**,但今天临时有事,需要调整为 14:00-16:00。

### 操作步骤

1. **点击编辑按钮**
   - 在时间轴上找到今天的"学习"时间段
   - 鼠标悬停,点击"编辑"按钮

2. **选择编辑模式**
   - 弹出对话框:
     ```
     这是一个重复的时间段。

     点击"确定"仅编辑今天这一次
     点击"取消"编辑所有重复
     ```
   - 选择 **"确定"** (仅编辑今天)

3. **修改时间段**
   - 表单显示蓝色提示框:
     ```
     ℹ️ 仅编辑今天这一次,不影响其他日期的重复时间段
     ```
   - 修改开始时间: 10:00 → 14:00
   - 修改结束时间: 12:00 → 16:00
   - 点击"保存"

4. **查看结果**
   - **今天**: 14:00-16:00 学习 (独立副本,显示 🔄 重复 标识)
   - **明天**: 10:00-12:00 学习 (原重复规则不变)
   - **后天及以后**: 10:00-12:00 学习 (原重复规则不变)

---

## 两种编辑模式对比

| 特性 | 仅编辑今天这一次 | 编辑所有重复 |
|------|----------------|------------|
| **影响范围** | 仅当天 | 所有重复日期 |
| **数据操作** | 创建独立副本 | 修改原始时间段 |
| **重复规则** | 无(副本不重复) | 可修改 |
| **其他日期** | 不受影响 | 同步更新 |
| **表单显示** | 隐藏重复选项 | 显示重复选项 |
| **使用场景** | 临时调整 | 永久修改 |

---

## 技术实现

### 独立副本机制

```typescript
// 时间段数据结构
interface TimeBlock {
  id: string                  // 唯一ID
  sourceBlockId?: string      // 独立副本引用原始ID
  date: string                // 日期
  startTime: string           // 开始时间
  endTime: string             // 结束时间
  activityType: string        // 活动类型
  description: string         // 描述
  recurrence: 'none' | ...    // 重复规则(副本总是'none')
}

// 示例: 原始重复时间段
{
  id: "abc-123",
  date: "2025-11-19",
  startTime: "10:00",
  endTime: "12:00",
  activityType: "study",
  description: "学习 Vue 3",
  recurrence: "daily"  // 每天重复
}

// 示例: 11月20日的独立副本
{
  id: "xyz-789",  // 新ID
  sourceBlockId: "abc-123",  // 引用原始ID
  date: "2025-11-20",
  startTime: "14:00",  // 调整后的时间
  endTime: "16:00",    // 调整后的时间
  activityType: "study",
  description: "学习 Vue 3",
  recurrence: "none"  // 副本不重复
}
```

### 显示逻辑

```typescript
// 获取某一天应该显示的时间段
function getTimeBlocksForDate(date: string) {
  return allTimeBlocks
    .filter(block => {
      // 1. 独立副本直接显示
      if (block.date === date && block.sourceBlockId) {
        return true
      }

      // 2. 原始时间段按重复规则判断
      if (!block.sourceBlockId) {
        return shouldTimeBlockAppear(block, date)
      }

      return false
    })
}

// 示例: 2025-11-20 显示的时间段
// 结果: [独立副本(14:00-16:00)]  ✅
// 原重复时间段(10:00-12:00) 被副本覆盖  ❌
```

---

## 注意事项

### 1. 副本优先级
- **有独立副本**: 显示副本,隐藏原重复时间段
- **无独立副本**: 显示原重复时间段生成的虚拟实例

### 2. 编辑已有副本
- 再次编辑同一天的时间段时,会更新已存在的副本
- 不会重复创建多个副本

### 3. 删除行为
- **删除副本**: 仅删除副本,恢复原重复时间段
- **删除原始**: 删除整个重复系列(包括所有副本)

### 4. 数据清理
- 副本是独立的时间段(`recurrence: 'none'`)
- 7天前的副本会被自动清理
- 原重复时间段不会被清理(除非手动删除)

---

## 常见问题

### Q1: 如何取消某一天的调整,恢复原重复时间?
**A**: 删除该天的独立副本即可。点击"删除"按钮,原重复时间段会重新显示。

### Q2: 调整后的时间段还会重复吗?
**A**: 不会。独立副本的 `recurrence` 始终为 `'none'`,仅在当天有效。

### Q3: 如果我想永久修改重复时间,怎么办?
**A**: 编辑时选择"编辑所有重复"(对话框中点击"取消"),这样会修改原始时间段,所有重复实例同步更新。

### Q4: 独立副本显示的"🔄 重复"标识是什么意思?
**A**: 表示这是一个从重复时间段衍生出来的独立副本,提醒用户这个时间段的来源。

### Q5: 能否一次调整多天?
**A**: 不能。目前只能一天一天地调整。如果需要调整连续几天,可以:
1. 修改原重复规则的结束日期,提前结束
2. 为新的时间段创建新的重复规则

---

## Git 提交历史

```bash
commit caa0008 - feat: 支持仅编辑重复时间段的某一天实例
commit f82ad40 - feat: 调整时间轴仅显示工作时间(10:00-18:00)
commit 36c760d - refactor: 重构为时间段日程管理应用
```

---

## 测试建议

访问 http://localhost:5174 测试以下场景:

1. **创建每天重复的时间段**
   - 添加"每天 10:00-11:00 工作"
   - 切换到明天,验证显示

2. **调整某一天**
   - 编辑明天的"工作"时间段
   - 选择"仅编辑今天这一次"
   - 修改为 14:00-15:00
   - 保存后验证:
     - 明天显示 14:00-15:00
     - 后天显示 10:00-11:00

3. **再次调整同一天**
   - 编辑明天的"工作"时间段
   - 再次修改为 16:00-17:00
   - 验证没有创建重复的副本

4. **删除调整**
   - 删除明天的独立副本
   - 验证恢复原重复时间(10:00-11:00)

5. **编辑所有重复**
   - 编辑任意一天的"工作"时间段
   - 选择"编辑所有重复"
   - 修改时间或描述
   - 验证所有日期同步更新

---

**文档生成时间**: 2025-11-19
**功能状态**: ✅ 已实现并提交
